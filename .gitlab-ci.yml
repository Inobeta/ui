image: node:10.11.0

stages:
  - deploy

deploy:
  stage: deploy
  script:
    - echo '//gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}'>.npmrc
    - npm install
    - npm run packagr
    - npm pack dist/
    - npm publish Inobeta-inobeta-ui-$CURRENT_VERSION.tgz --tag latest
  only:
    - master
deploy_unstable:
  stage: deploy
  script:
    - echo '//gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}'>.npmrc
    - create_temp_version
    - npm install
    - npm run packagr
    - npm pack dist/
    - npm publish Inobeta-inobeta-ui-$TEMP_VERSION.tgz --tag unstable
  only:
    - /^v[0-9]+\.[0-9]+\.[0-9]+$/
deploy_manual_unstable:
  stage: deploy
  script:
    - echo '//gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}'>.npmrc
    - create_temp_version
    - npm install
    - npm run packagr
    - npm pack dist/
    - npm publish Inobeta-inobeta-ui-$TEMP_VERSION.tgz --tag testing
  except:
    - master
    - /^v[0-9]+\.[0-9]+\.[0-9]+$/
  when:
    - manual
test_package_creation:
  stage: deploy
  script:
    - echo '//gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/npm/:_authToken=${CI_JOB_TOKEN}'>.npmrc
    - create_temp_version
    - npm install
    - npm run packagr
    - npm pack dist/
  except:
    - master
    - /^v[0-9]+\.[0-9]+\.[0-9]+$/
pages:
  stage: deploy
  script:
    - npx @compodoc/compodoc -p tsconfig.app.json --disableCoverage --disableDomTree --disableGraph --hideGenerator
    - dir="$CURRENT_VERSION"
    - if [ "$CI_COMMIT_REF_SLUG" == "$CI_DEFAULT_BRANCH" ]; then dir="current"; fi;
    - mkdir -p public
    - mkdir -p public/$dir/
    - rm -rf public/$dir/documentation
    - mv documentation public/$dir/
  artifacts:
    name: "$CI_COMMIT_REF_SLUG-$CURRENT_VERSION"
    paths:
      - public
  cache:
    paths:
    - public
  only:
    - master
    - /^v[0-9]+\.[0-9]+\.[0-9]+$/
.inobeta_pkg: &inobeta_pkg |
  [[ "$TRACE" ]] && set -x

  function set_current_version() {
    CURRENT_VERSION=$(cat package.json | grep version | head -1 | awk -F: '{ print $2 }' | sed 's/[\",]//g' | tr -d '[[:space:]]')
  }

  function create_temp_version() {
      TEMP_VERSION=$CURRENT_VERSION-build.$(date +%s)
      sed -i "s/\"version\"\: \"$CURRENT_VERSION\"/\"version\": \"$TEMP_VERSION\"/g" ./package.json
      echo $TEMP_VERSION
  }

before_script:
  - *inobeta_pkg
  - set_current_version

